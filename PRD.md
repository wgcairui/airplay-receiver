# AirPlay接收端APP - 产品需求文档(PRD)

## 📖 产品概述

### 产品名称
**PadCast** - OPPO Pad AirPlay接收端应用

### 产品愿景
将OPPO Pad 4 Pro打造为Mac的无线扩展显示器，提供低延迟、高质量的投屏体验，充分发挥平板的3.4K高分辨率和144Hz高刷新率优势。

### 目标用户
- Mac用户（macOS 10.15+）
- OPPO Pad 4 Pro用户
- 需要多屏工作环境的专业用户
- 创意工作者、程序员、设计师

## 🎯 产品目标

### 主要目标
1. **功能目标**: 实现稳定的AirPlay镜像接收功能
2. **性能目标**: 延迟控制在50ms以内，支持4K@60fps
3. **体验目标**: 一键连接，操作简单，界面美观
4. **兼容目标**: 支持macOS 10.15-14.x全版本

### 关键指标
- 连接成功率 > 95%
- 平均延迟 < 50ms
- 视频质量支持最高3392×2400@144Hz
- 应用启动时间 < 3秒
- 电池续航影响 < 15%/小时

## 👥 用户画像与使用场景

### 主要用户画像

#### 1. 移动办公族 - 张工程师
- **背景**: 软件工程师，经常需要多屏调试代码
- **需求**: 将MacBook代码扩展到平板，提高开发效率
- **痛点**: 外接显示器不便携，咖啡厅无法使用双屏

#### 2. 创意设计师 - 李设计
- **背景**: UI/UX设计师，使用Mac进行设计工作
- **需求**: 平板作为第二屏显示参考素材或预览效果
- **痛点**: 需要大屏预览设计稿，iPad连接复杂

#### 3. 商务人士 - 王总监  
- **背景**: 经常出差开会，需要展示PPT和数据
- **需求**: 用平板作为便携展示屏，会议室投屏
- **痛点**: 投影仪连接麻烦，线缆容易丢失

### 核心使用场景

#### 场景1: 日常办公扩展屏
```
用户故事: 作为程序员，我希望在咖啡厅用平板作为第二屏
显示代码，这样我可以提高工作效率。

前置条件: Mac和平板连接同一WiFi
操作流程: 
1. 打开PadCast应用
2. Mac选择AirPlay到OPPO Pad
3. 自动连接并显示桌面扩展
4. 调整显示分辨率和位置

预期结果: 延迟<50ms，画质清晰，操作流畅
```

#### 场景2: 会议演示
```
用户故事: 作为销售，我希望用平板展示PPT给客户看，
无需连接线缆。

前置条件: Mac和平板在会议室WiFi环境
操作流程:
1. 平板开启PadCast等待连接
2. Mac开启屏幕镜像
3. 选择OPPO Pad设备
4. 自动完成连接
5. 全屏显示演示内容

预期结果: 连接稳定，支持触控操作，画面无卡顿
```

#### 场景3: 创意设计预览
```
用户故事: 作为设计师，我希望在平板上实时预览
Sketch/Figma的设计稿效果。

前置条件: Mac运行设计软件，平板待机
操作流程:
1. 平板快速开启投屏接收（控制中心小组件）
2. Mac通过AirPlay连接
3. 设置为扩展显示模式
4. 将设计窗口拖拽到平板屏幕
5. 实时查看设计效果和颜色

预期结果: 色彩准确，支持高刷新率，触控交互
```

## 🔧 功能需求详述

### 核心功能 (MVP)

#### 1. AirPlay服务发现与连接
**功能描述**: 自动发现并连接Mac设备的AirPlay请求
- mDNS服务广播，让Mac发现设备
- 显示设备名称为"OPPO Pad - PadCast"
- 支持自动连接认证方式
- 连接状态实时显示和错误提示

**验收标准**:
- [ ] Mac能在AirPlay列表中发现OPPO Pad
- [ ] 连接成功率>95%（同一网络环境下）
- [ ] 支持自动连接，无需额外验证步骤
- [ ] 支持记住已配对设备，后续快速连接

#### 2. 视频流接收与渲染
**功能描述**: 接收并显示Mac传输的视频流
- 支持H.264/H.265视频解码
- 自适应分辨率调整（最高3392×2400）
- 硬件加速渲染，支持144Hz刷新率
- 音频同步播放

**验收标准**:
- [ ] 支持1080p、4K分辨率切换
- [ ] 延迟控制在50ms以内
- [ ] 支持60fps、144fps帧率显示
- [ ] 音画同步误差<40ms
- [ ] 长时间播放无卡顿和花屏

#### 3. 双屏模式支持
**功能描述**: 支持镜像和扩展两种显示模式
- 镜像模式：完全复制Mac屏幕内容
- 扩展模式：作为Mac的第二屏使用
- 分辨率和显示方向自适应
- 支持横竖屏切换

**验收标准**:
- [ ] 镜像模式画面比例正确无变形
- [ ] 扩展模式支持独立窗口拖拽
- [ ] 横竖屏切换响应时间<2秒
- [ ] 支持Mac系统偏好设置中的显示器排列

### 增强功能

#### 4. Android小组件支持
**功能描述**: 在OPPO控制中心添加快捷开关
- 控制中心磁贴显示连接状态
- 一键开启/关闭AirPlay接收
- 显示当前连接设备名称
- 快速访问应用设置

**验收标准**:
- [ ] 控制中心磁贴可正常添加和显示
- [ ] 磁贴状态与应用状态同步
- [ ] 点击磁贴可快速切换服务状态
- [ ] 长按磁贴可进入应用设置

#### 5. 触控交互支持
**功能描述**: 将平板触控操作反馈给Mac
- 单指点击 → 鼠标左键
- 双指滚动 → 鼠标滚轮
- 双指捏合 → 缩放操作
- 支持多点触控手势

**验收标准**:
- [ ] 触控点击位置准确映射
- [ ] 滚动操作流畅无延迟
- [ ] 缩放手势响应正确
- [ ] 支持最多5点触控

#### 6. 性能监控与优化
**功能描述**: 实时监控传输质量和设备性能
- 显示当前帧率、延迟、码率
- CPU/GPU使用率监控
- 网络带宽占用显示
- 电池消耗优化

**验收标准**:
- [ ] 实时显示传输参数
- [ ] CPU占用率<30%（1080p@60fps）
- [ ] GPU使用率<50%（4K@60fps）
- [ ] 电池消耗<15%/小时
- [ ] 发热控制在正常范围

### 高级功能（后续版本）

#### 7. 多设备管理
- 支持多台Mac设备连接历史
- 设备优先级设置
- 黑名单/白名单管理

#### 8. 专业显示特性
- HDR内容支持
- 色彩空间配置（sRGB、P3、Rec.2020）
- 刷新率锁定选项
- 低蓝光护眼模式

#### 9. 高级网络功能
- 5G网络连接支持
- VPN环境兼容性
- 网络质量自适应调整
- 离线缓存预览

## 📱 技术规格

### Flutter技术栈
```yaml
Flutter SDK: ^3.24.0
Dart: ^3.5.0

主要依赖:
- network_info_plus: 网络信息获取
- multicast_dns: mDNS服务发现  
- video_player: 视频播放
- home_widget: Android小组件
- provider: 状态管理
- flutter_native_splash: 启动页
```

### 平台特定实现
```kotlin
// Android原生代码 (Kotlin)
- AirPlay协议实现 (HTTP + RTSP)
- MediaCodec硬件解码
- Surface渲染和显示
- 网络服务和广播
- 小组件UI实现
```

### 性能要求
- **最低Android版本**: Android 7.0 (API 24)
- **推荐Android版本**: Android 12+ (API 31+)
- **内存占用**: 运行时<500MB，待机<100MB  
- **CPU要求**: 支持硬件解码的ARM64处理器
- **网络要求**: WiFi 5 (802.11ac) 或更高

### OPPO Pad 4 Pro适配
```
屏幕规格: 3392×2400像素，13.2英寸，7:5比例
处理器: 高通骁龙8至尊版 4.32GHz
内存: 8GB LPDDR5X
GPU: Adreno 830 @ 1.1GHz
刷新率: 144Hz自适应
```

## 🎨 UI/UX设计规范

### 设计原则
1. **简洁明了**: 界面简洁，功能一目了然
2. **快速响应**: 操作响应迅速，减少等待时间
3. **状态清晰**: 连接状态、传输质量清晰可见
4. **平板优化**: 充分利用大屏空间和高分辨率

### 界面结构

#### 主界面 (Home Page)
```
┌─────────────────────────────────────┐
│ ◀ PadCast               ⚙️ 🔔      │
├─────────────────────────────────────┤
│                                     │
│        📺 等待连接...                │
│                                     │
│    [设备名称: OPPO Pad - PadCast]   │
│                                     │
│         ┌─────────────┐             │
│         │   等待连接   │             │
│         │   状态图标   │             │
│         └─────────────┘             │
│                                     │
│    📶 WiFi: OfficeNetwork          │
│    🔗 状态: 等待连接                │
│                                     │
│    [🎯 开启接收]  [⚙️ 设置]        │
│                                     │
└─────────────────────────────────────┘
```

#### 投屏界面 (Streaming Page)
```
┌─────────────────────────────────────┐
│ ╔═══════════════════════════════════╗ │
│ ║                                   ║ │
│ ║        Mac屏幕内容区域            ║ │
│ ║     (全屏显示，最小化UI)          ║ │
│ ║                                   ║ │
│ ║                                   ║ │
│ ║                                   ║ │
│ ╚═══════════════════════════════════╝ │
│                                     │
│ ┌─ 状态栏（半透明，可隐藏） ───────┐   │
│ │ 🔗 已连接 MacBook Pro │ 📊 60fps │   │
│ │ 延迟: 25ms │ 🔋 89% │ 📶 WiFi6  │   │
│ └─────────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 设置页面 (Settings Page)
```
┌─────────────────────────────────────┐
│ ◀ 设置                              │
├─────────────────────────────────────┤
│ 🖥️ 显示设置                         │
│   分辨率: 3392×2400 (原生) ▼        │
│   刷新率: 144Hz ▼                   │
│   显示模式: 扩展屏幕 ▼               │
│                                     │
│ 🎥 视频设置                         │
│   质量: 高 ▼                        │
│   硬件加速: ✅ 开启                  │
│   低延迟模式: ✅ 开启                │
│                                     │
│ 🔗 连接设置                         │
│   设备名称: [OPPO Pad - PadCast]    │
│   自动连接: ✅ 开启                  │
│                                     │
│ 🔧 高级设置                         │
│   性能监控: ⬜ 显示                  │
│   日志记录: ⬜ 开启                  │
│   开发者模式: ⬜ 开启                │
└─────────────────────────────────────┘
```

### 视觉设计规范

#### 色彩规范
- **主色调**: #007AFF (iOS蓝) 或 OPPO品牌色
- **辅助色**: #34C759 (成功绿), #FF3B30 (错误红)
- **背景色**: #F2F2F7 (浅灰), #000000 (投屏黑)
- **文字色**: #000000 (主), #8E8E93 (辅)

#### 字体规范  
- **标题**: SF Pro Display / Roboto, 28sp, Medium
- **正文**: SF Pro Text / Roboto, 16sp, Regular
- **辅助**: SF Pro Text / Roboto, 14sp, Light

#### 组件规范
- **按钮**: 最小点击区域44×44dp，圆角8dp
- **卡片**: 阴影elevation 4dp，圆角12dp
- **间距**: 8dp基础网格，页边距16dp
- **图标**: 24×24dp标准尺寸，遵循Material Icons

## 📋 开发计划与里程碑

### 第一阶段：基础框架 ✅ **已完成** (2周)
**目标**: 搭建项目基础和核心架构

**任务列表**:
- [x] 创建Flutter项目结构
- [x] 配置Android权限和依赖
- [x] 实现基础UI界面和导航
- [x] 设置状态管理(Provider)
- [x] 添加基础日志和错误处理

**验收标准**:
- ✅ 应用可正常启动和导航
- ✅ 基础UI适配OPPO Pad分辨率  
- ✅ 状态管理正常工作

**开发成果**:
- 完成Flutter项目初始化，配置了pubspec.yaml和Android权限
- 实现了主页面(HomeView)、设置页面(SettingsView)和相关组件
- 建立了MVC架构：Models(连接状态)、Controllers(AirPlay控制器)、Services(AirPlay服务)
- 集成Provider状态管理，实现响应式UI更新
- 适配OPPO Pad 3392×2400分辨率和Material 3设计

### 第二阶段：网络发现 ✅ **已完成** (2周)  
**目标**: 实现mDNS服务发现和设备配对

**任务列表**:
- [x] 实现mDNS广播服务
- [x] 创建HTTP服务器接收连接
- [x] 实现设备配对和认证流程（简化版，无PIN码）
- [x] 添加网络状态监控
- [x] 优化mDNS协议实现

**验收标准**:
- ✅ Mac能发现OPPO Pad设备
- ✅ 配对流程完整可用
- ✅ 网络异常处理正确

**完成成果**:
- ✅ 完成完整的mDNS服务实现，符合AirPlay协议标准
- ✅ 实现网络监控服务，实时显示WiFi状态和IP地址
- ✅ HTTP服务器支持/info、/pair-setup、/stream等核心接口
- ✅ 去除PIN码验证，简化连接流程
- ✅ 添加连接状态管理和错误处理

### 第三阶段：视频传输 ✅ **已完成** (3周)
**目标**: 实现核心AirPlay视频传输功能

**任务列表**:
- [x] 实现RTSP协议处理
- [x] 集成视频解码框架（H.264/H.265）
- [x] 实现视频流渲染显示
- [x] 添加音视频同步机制
- [x] 优化缓冲和延迟控制

**验收标准**:
- ✅ RTSP协议解析和响应正确
- ✅ 视频解码框架集成完成
- ✅ 音视频同步机制实现
- ✅ 延迟优化目标<50ms

**完成成果**:
- ✅ 实现完整的RTSP服务，支持OPTIONS、DESCRIBE、SETUP、PLAY、TEARDOWN
- ✅ 创建VideoDecoderService视频解码框架，支持原生MediaCodec集成
- ✅ 实现AudioVideoSyncService音视频同步服务，40ms同步阈值
- ✅ 集成VideoRendererWidget视频渲染组件，支持全屏播放和控制UI

### 第四阶段：性能优化 ✅ **已完成** (2周)
**目标**: 优化性能，降低延迟，提升体验

**任务列表**:
- [x] 实现性能监控系统
- [x] 添加自动优化服务
- [x] 优化内存和CPU使用
- [x] 实现延迟控制优化
- [x] 添加动态质量调整

**验收标准**:
- ✅ 延迟目标<50ms
- ✅ 智能性能优化
- ✅ 资源使用监控

**完成成果**:
- ✅ 实现PerformanceMonitorService性能监控，追踪CPU、内存、帧率、延迟
- ✅ 创建PerformanceOptimizationService自动优化服务，支持四种优化模式
- ✅ 集成动态质量调整，根据系统性能自动切换配置档案
- ✅ 实现低延迟模式，缓冲区优化，目标延迟<50ms
- ✅ 添加硬件加速支持和GPU优化接口

### 第五阶段：扩展功能 (2周)
**目标**: 实现Android小组件和触控交互

**任务列表**:
- [ ] 开发Android小组件
- [ ] 实现触控事件映射
- [ ] 添加多点触控支持
- [ ] 完善设置页面功能
- [ ] 添加性能监控界面

**验收标准**:
- 小组件正常工作
- 触控操作响应准确
- 设置功能完整可用

### 第六阶段：测试发布 (1周)
**目标**: 完成测试和发布准备

**任务列表**:
- [ ] 全功能测试和bug修复
- [ ] 性能和稳定性测试
- [ ] 用户界面和体验优化
- [ ] 文档编写和整理
- [ ] 准备发布版本

**验收标准**:
- 核心功能稳定可用
- 用户体验符合预期
- 性能指标达到要求

## ⚠️ 风险评估与缓解

### 技术风险

#### 高风险
**AirPlay协议实现复杂性**
- 风险描述: Apple未公开完整AirPlay协议，需要逆向工程
- 影响: 可能导致兼容性问题，开发周期延长
- 缓解策略: 
  - 深入研究开源实现(UxPlay、RPiPlay)
  - 多版本macOS测试验证
  - 制定降级兼容方案

**硬件解码兼容性**
- 风险描述: 不同Android设备MediaCodec实现差异
- 影响: 视频播放异常，性能不达标
- 缓解策略:
  - 优先适配OPPO Pad 4 Pro
  - 软解码作为备选方案
  - 充分的设备测试

#### 中风险
**网络环境复杂性**
- 风险描述: 企业网络、防火墙可能阻拦mDNS
- 影响: 设备发现失败，无法连接
- 缓解策略:
  - 提供手动IP连接选项
  - 支持多种发现机制
  - 详细的网络故障诊断

**性能延迟控制**
- 风险描述: 网络传输和解码延迟难以控制
- 影响: 用户体验不佳，不适用于实时操作
- 缓解策略:
  - 多级缓冲优化
  - 网络质量自适应
  - 硬件加速最大化利用

#### 低风险  
**UI适配和用户体验**
- 风险描述: 平板UI设计和交互体验
- 影响: 用户接受度不高
- 缓解策略:
  - 深入用户调研
  - 迭代设计优化
  - A/B测试验证

### 商业风险

#### 知识产权风险
- 风险描述: AirPlay是Apple专有协议
- 影响: 可能面临法律风险
- 缓解策略:
  - 基于公开逆向工程成果
  - 不使用Apple商标和版权内容
  - 明确标注第三方实现

#### 市场竞争风险
- 风险描述: 类似产品竞争激烈
- 影响: 市场份额和用户获取困难
- 缓解策略:
  - 专注OPPO Pad优化差异化
  - 提供独特的小组件功能
  - 持续功能迭代和优化

### 缓解时间表

| 风险项目 | 评估时间 | 缓解措施开始 | 预期完成 |
|---------|----------|--------------|----------|
| 协议兼容性测试 | Week 1 | Week 2 | Week 4 |
| 硬件解码验证 | Week 2 | Week 3 | Week 5 |
| 网络环境测试 | Week 4 | Week 5 | Week 7 |
| 性能优化 | Week 6 | Week 7 | Week 9 |

## 📊 成功度量指标

### 功能完成度指标
- [ ] 核心功能完成率: 100%
- [ ] 增强功能完成率: ≥80%
- [ ] 高级功能完成率: ≥30%

### 技术性能指标  
- [ ] 连接成功率: >95%
- [ ] 视频传输延迟: <50ms
- [ ] 音画同步误差: <40ms  
- [ ] CPU使用率: <30% (1080p@60fps)
- [ ] 内存占用: 运行时<500MB
- [ ] 应用启动时间: <3秒
- [ ] 崩溃率: <0.1%

### 用户体验指标
- [ ] 界面响应时间: <200ms
- [ ] 操作成功率: >98%
- [ ] 用户满意度: ≥4.5/5.0
- [ ] 功能易用性评分: ≥4.0/5.0

### 兼容性指标
- [ ] macOS版本支持: 10.15-14.x
- [ ] 网络环境兼容: >90%
- [ ] 视频格式支持: H.264/H.265
- [ ] 分辨率支持: 1080p-4K

## 📚 附录

### 参考资料
- [AirPlay协议分析](https://nto.github.io/AirPlay.html)
- [UxPlay开源项目](https://github.com/FDH2/UxPlay)  
- [Flutter插件开发指南](https://docs.flutter.dev/development/packages-and-plugins)
- [Android MediaCodec文档](https://developer.android.com/guide/topics/media/mediacodec)

### 术语解释
- **AirPlay**: Apple的无线显示协议
- **mDNS**: 多播DNS，用于设备发现
- **RTSP**: 实时流传输协议
- **MediaCodec**: Android硬件编解码API
- **Flutter**: Google的跨平台开发框架

---

## 🔧 当前技术挑战

### 已解决问题
1. **Flutter项目架构** - 成功搭建MVC架构和状态管理
2. **UI适配** - 完成OPPO Pad 3392×2400分辨率适配
3. **基础网络服务** - HTTP服务器和基础mDNS集成完成

### 待解决问题
1. **mDNS协议兼容性** 
   - 当前使用multicast_dns包的基础功能
   - 需要实现完整的AirPlay服务记录格式
   - 可能需要原生Android代码实现更精确的mDNS广播

2. **视频流处理**
   - 尚未实现RTSP协议处理
   - 需要集成MediaCodec进行硬件解码
   - Surface渲染和音视频同步待实现

3. **性能优化**
   - 延迟控制目标50ms以内待验证
   - CPU/内存使用率优化
   - 电池续航影响控制

### 下一步计划
1. 在真实设备上测试mDNS发现功能
2. 研究AirPlay协议详细规范，优化兼容性
3. 开始视频流传输功能的原型开发

---

**文档版本**: v1.1  
**创建日期**: 2024-08-21  
**最后更新**: 2024-08-21  
**审核状态**: 开发中 - 第一阶段已完成，第二阶段进行中